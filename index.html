<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shipt Delivery Tracker</title>
    <style>
        /* ===== CSS VARIABLES ===== */
        :root {
            /* Shipt-inspired Primary palette - Teal */
            --primary-50: #e6f7f8;
            --primary-100: #b3e8eb;
            --primary-200: #80d9de;
            --primary-300: #4dcad1;
            --primary-400: #1abbc4;
            --primary-500: #006B75;
            --primary-600: #005d66;
            --primary-700: #004f57;
            --primary-800: #004148;
            --primary-900: #003339;

            /* Success palette - teal/emerald */
            --success-50: #ecfdf5;
            --success-100: #d1fae5;
            --success-200: #a7f3d0;
            --success-300: #6ee7b7;
            --success-400: #34d399;
            --success-500: #10b981;
            --success-600: #059669;
            --success-700: #047857;

            /* Danger palette - rose/red */
            --danger-50: #fff1f2;
            --danger-100: #ffe4e6;
            --danger-200: #fecdd3;
            --danger-300: #fda4af;
            --danger-400: #fb7185;
            --danger-500: #f43f5e;
            --danger-600: #e11d48;
            --danger-700: #be123c;

            /* Neutral palette */
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #666666;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1a1a1a;
            --gray-900: #111827;

            /* Accent colors - subtle purple gradients for stats */
            --accent-purple-light: rgba(139, 92, 246, 0.1);
            --accent-purple-med: rgba(139, 92, 246, 0.2);

            /* Backgrounds */
            --bg-light-mint: #E8F5F7;
            --bg-white: #FFFFFF;

            /* Gradients - more subtle */
            --gradient-primary: linear-gradient(135deg, #006B75 0%, #008a96 100%);
            --gradient-success: linear-gradient(135deg, #10b981 0%, #34d399 100%);
            --gradient-danger: linear-gradient(135deg, #f43f5e 0%, #fb7185 100%);
            --gradient-accent: linear-gradient(135deg, rgba(139, 92, 246, 0.15) 0%, rgba(168, 85, 247, 0.15) 100%);

            /* Shadows - cleaner, softer */
            --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.08);
            --shadow-md: 0 2px 8px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 4px 12px rgba(0, 0, 0, 0.12);
            --shadow-xl: 0 8px 20px rgba(0, 0, 0, 0.15);
            --shadow-card: 0 2px 8px rgba(0, 0, 0, 0.1);

            /* Spacing */
            --space-xs: 4px;
            --space-sm: 8px;
            --space-md: 16px;
            --space-lg: 24px;
            --space-xl: 32px;
            --space-2xl: 48px;

            /* Border radius */
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 20px;
            --radius-pill: 24px;
            --radius-full: 9999px;

            /* Transitions */
            --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-normal: 250ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: 350ms cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* ===== RESET & BASE ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: var(--bg-light-mint);
            background-attachment: fixed;
            min-height: 100vh;
            padding: 0;
            color: var(--gray-800);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            line-height: 1.6;
            letter-spacing: 0.3px;
        }

        /* ===== BOTTOM NAVIGATION ===== */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 70px;
            background: var(--primary-500);
            display: flex;
            align-items: center;
            justify-content: space-around;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            padding-bottom: env(safe-area-inset-bottom);
        }

        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: rgba(255, 255, 255, 0.7);
            transition: all var(--transition-fast);
            padding: var(--space-sm);
            text-decoration: none;
            gap: 4px;
            height: 100%;
        }

        .nav-item:active {
            transform: scale(0.95);
        }

        .nav-item.active {
            color: white;
        }

        .nav-icon {
            font-size: 24px;
            transition: all var(--transition-fast);
        }

        .nav-item.active .nav-icon {
            transform: scale(1.1);
        }

        .nav-label {
            font-size: 11px;
            font-weight: 500;
            letter-spacing: 0.3px;
        }

        /* Shop button - special elevated style */
        .nav-item.shop-btn {
            position: relative;
            top: -10px;
        }

        .nav-item.shop-btn .nav-icon {
            width: 56px;
            height: 56px;
            background: white;
            color: var(--primary-500);
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            box-shadow: var(--shadow-lg);
            border: 3px solid var(--primary-500);
        }

        .nav-item.shop-btn.active .nav-icon {
            background: var(--primary-100);
            transform: scale(1.05);
        }

        .nav-item.shop-btn .nav-label {
            color: white;
            font-weight: 600;
        }

        /* ===== MAIN CONTAINER ===== */
        .container {
            max-width: 480px;
            margin: 0 auto;
            background: transparent;
            min-height: 100vh;
            padding: var(--space-xl);
            padding-top: var(--space-2xl);
            padding-bottom: calc(70px + var(--space-xl) + env(safe-area-inset-bottom));
        }

        h1 {
            text-align: center;
            color: var(--primary-600);
            margin-bottom: var(--space-xl);
            font-size: 28px;
            font-weight: 700;
            letter-spacing: -0.3px;
        }

        /* ===== PAGES ===== */
        .page {
            display: none;
            animation: fadeIn var(--transition-normal) ease-out;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ===== ORDER COUNTER ===== */
        .order-counter {
            background: var(--bg-white);
            border-radius: var(--radius-lg);
            padding: var(--space-xl);
            margin-bottom: var(--space-lg);
            text-align: center;
            border: none;
            box-shadow: var(--shadow-card);
        }

        .counter-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--gray-500);
            text-transform: uppercase;
            letter-spacing: 1.2px;
            margin-bottom: var(--space-lg);
        }

        .counter-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: var(--space-xl);
        }

        .counter-btn {
            width: 48px;
            height: 48px;
            border-radius: var(--radius-full);
            border: 2px solid var(--primary-500);
            background: var(--bg-white);
            color: var(--primary-500);
            font-size: 24px;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-normal);
            box-shadow: var(--shadow-sm);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .counter-btn:hover:not(:disabled) {
            transform: scale(1.05);
            background: var(--primary-500);
            color: white;
            box-shadow: var(--shadow-md);
        }

        .counter-btn:active:not(:disabled) {
            transform: scale(0.98);
        }

        .counter-btn:disabled {
            background: var(--gray-100);
            color: var(--gray-400);
            border-color: var(--gray-300);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .counter-value {
            font-size: 48px;
            font-weight: 700;
            color: var(--primary-600);
            min-width: 80px;
        }

        /* ===== TIMER DISPLAY ===== */
        .timer-display {
            background: var(--bg-white);
            border-radius: var(--radius-lg);
            padding: var(--space-xl);
            margin-bottom: var(--space-lg);
            text-align: center;
            border: none;
            box-shadow: var(--shadow-card);
        }

        .timer-label {
            font-size: 13px;
            font-weight: 600;
            color: var(--gray-500);
            margin-bottom: var(--space-md);
            text-transform: uppercase;
            letter-spacing: 1.2px;
        }

        .timer-value {
            font-size: 40px;
            font-weight: 700;
            color: var(--primary-600);
            font-variant-numeric: tabular-nums;
            letter-spacing: 1px;
        }

        /* ===== STATUS DISPLAY ===== */
        .status-display {
            background: var(--bg-white);
            color: var(--primary-600);
            border-radius: var(--radius-lg);
            padding: var(--space-xl);
            margin-bottom: var(--space-lg);
            text-align: center;
            box-shadow: var(--shadow-card);
            border: 2px solid var(--primary-500);
        }

        .status-text {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 4px;
            letter-spacing: 0.2px;
            color: var(--primary-600);
        }

        .status-subtext {
            font-size: 14px;
            opacity: 0.8;
            font-weight: 500;
            color: var(--gray-600);
        }

        /* ===== BUTTONS ===== */
        button.action-btn {
            width: 100%;
            padding: 12px var(--space-lg);
            border: none;
            border-radius: var(--radius-pill);
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-normal);
            letter-spacing: 0.3px;
            margin-bottom: var(--space-md);
            box-shadow: var(--shadow-sm);
        }

        .btn-primary {
            background: var(--primary-500);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--primary-600);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .btn-primary:active:not(:disabled) {
            transform: translateY(0);
        }

        .btn-success {
            background: var(--primary-500);
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background: var(--primary-600);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .btn-success:active:not(:disabled) {
            transform: translateY(0);
        }

        .btn-danger {
            background: var(--danger-500);
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            background: var(--danger-600);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .btn-danger:active:not(:disabled) {
            transform: translateY(0);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }

        /* ===== MODAL ===== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity var(--transition-normal);
        }

        .modal.show {
            display: flex;
            opacity: 1;
        }

        .modal-content {
            background: white;
            border-radius: var(--radius-lg);
            padding: var(--space-xl);
            max-width: 340px;
            width: 90%;
            text-align: center;
            box-shadow: var(--shadow-xl);
            transform: scale(0.95);
            transition: transform var(--transition-normal);
        }

        .modal.show .modal-content {
            transform: scale(1);
        }

        .modal-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--gray-800);
            margin-bottom: var(--space-md);
        }

        .modal-text {
            font-size: 15px;
            color: var(--gray-600);
            margin-bottom: var(--space-xl);
            line-height: 1.6;
        }

        .modal-buttons {
            display: flex;
            gap: var(--space-md);
        }

        .modal-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: var(--radius-pill);
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .modal-btn-cancel {
            background: var(--gray-100);
            color: var(--gray-700);
            border: 1px solid var(--gray-300);
        }

        .modal-btn-cancel:hover {
            background: var(--gray-200);
        }

        .modal-btn-confirm {
            background: var(--danger-500);
            color: white;
        }

        .modal-btn-confirm:hover {
            background: var(--danger-600);
            transform: translateY(-1px);
            box-shadow: var(--shadow-sm);
        }

        /* ===== PLACEHOLDER PAGE ===== */
        .placeholder-page {
            text-align: center;
            padding: var(--space-2xl) var(--space-lg);
            color: var(--gray-500);
            background: var(--bg-white);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-card);
        }

        .placeholder-icon {
            font-size: 64px;
            margin-bottom: var(--space-md);
            opacity: 0;
            display: none;
        }

        .placeholder-text {
            font-size: 16px;
            font-weight: 500;
            color: var(--gray-500);
        }

        .hidden {
            display: none;
        }

        .empty-history {
            text-align: center;
            color: var(--gray-500);
            padding: var(--space-2xl) var(--space-lg);
            font-size: 15px;
            font-weight: 500;
            background: var(--bg-white);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-card);
        }

        /* ===== HISTORY ITEM (PAST ORDERS) ===== */
        .history-item-compact {
            background: var(--bg-white);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            margin-bottom: var(--space-md);
            position: relative;
            cursor: pointer;
            transition: all var(--transition-normal);
            border: none;
            box-shadow: var(--shadow-card);
        }

        .history-item-compact:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .delete-btn-compact {
            position: absolute;
            top: var(--space-md);
            right: var(--space-md);
            width: 30px;
            height: 30px;
            border-radius: var(--radius-full);
            border: none;
            background: var(--danger-50);
            color: var(--danger-500);
            font-size: 18px;
            font-weight: 400;
            line-height: 1;
            cursor: pointer;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .delete-btn-compact:hover {
            background: var(--danger-500);
            color: white;
            transform: scale(1.08);
        }

        .compact-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--space-md);
            padding-right: 40px;
        }

        .compact-order-info {
            font-size: 14px;
            font-weight: 700;
            color: var(--primary-600);
        }

        .compact-date {
            font-size: 13px;
            font-weight: 600;
            color: var(--gray-500);
        }

        .compact-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-sm);
        }

        .compact-stat-box {
            background: var(--primary-50);
            padding: var(--space-md);
            border-radius: var(--radius-md);
            text-align: center;
            border: none;
        }

        .compact-stat-label {
            font-size: 10px;
            font-weight: 600;
            color: var(--gray-500);
            text-transform: uppercase;
            letter-spacing: 0.8px;
            margin-bottom: 6px;
        }

        .compact-stat-value {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary-600);
        }

        .compact-stat-value.too-long {
            font-size: 12px;
            color: var(--danger-500);
            font-weight: 600;
        }

        /* ===== MESSAGE TABS ===== */
        .messages-wrapper {
            margin-top: var(--space-lg);
            background: var(--bg-white);
            border-radius: var(--radius-lg);
            overflow: hidden;
            border: none;
            box-shadow: var(--shadow-card);
        }

        .messages-tabs {
            display: flex;
            background: var(--primary-50);
            border-bottom: 1px solid var(--primary-100);
            padding: var(--space-xs);
            gap: var(--space-xs);
        }

        .messages-tab {
            flex: 1;
            padding: 10px var(--space-xs);
            text-align: center;
            font-size: 11px;
            font-weight: 600;
            color: var(--gray-500);
            cursor: pointer;
            transition: all var(--transition-fast);
            border: none;
            background: transparent;
            border-radius: var(--radius-sm);
        }

        .messages-tab:hover {
            background: var(--primary-100);
            color: var(--primary-600);
        }

        .messages-tab.active {
            background: var(--primary-500);
            color: white;
            box-shadow: var(--shadow-sm);
        }

        .messages-container {
            max-height: 200px;
            overflow-y: auto;
            padding: var(--space-md);
            display: none;
            background: var(--bg-white);
        }

        .messages-container.active {
            display: block;
        }

        .message-box {
            background: var(--primary-50);
            border-radius: var(--radius-md);
            padding: var(--space-md);
            margin-bottom: var(--space-sm);
            position: relative;
            box-shadow: var(--shadow-sm);
            border: none;
            transition: all var(--transition-fast);
        }

        .message-box:hover {
            box-shadow: var(--shadow-md);
        }

        .message-box:last-child {
            margin-bottom: 0;
        }

        .message-text {
            font-size: 14px;
            color: var(--gray-700);
            line-height: 1.5;
            padding-right: 70px;
        }

        .copy-btn {
            position: absolute;
            top: 50%;
            right: var(--space-md);
            transform: translateY(-50%);
            background: var(--primary-500);
            color: white;
            border: none;
            padding: 8px 14px;
            border-radius: var(--radius-pill);
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .copy-btn:hover {
            background: var(--primary-600);
            transform: translateY(-50%) scale(1.05);
        }

        .copy-btn:active {
            transform: translateY(-50%) scale(0.98);
        }

        .copy-btn.copied {
            background: var(--success-500);
        }

        /* ===== SCROLLBAR STYLING ===== */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: var(--gray-100);
            border-radius: var(--radius-full);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--gray-300);
            border-radius: var(--radius-full);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--gray-400);
        }

        /* ===== MOBILE OPTIMIZATIONS ===== */
        @media (max-width: 480px) {
            .container {
                padding: var(--space-lg);
                padding-top: var(--space-xl);
                padding-bottom: calc(70px + var(--space-lg) + env(safe-area-inset-bottom));
            }

            h1 {
                font-size: 22px;
                margin-bottom: var(--space-lg);
            }

            .counter-value {
                font-size: 44px;
            }

            .timer-value {
                font-size: 36px;
            }

            button.action-btn {
                padding: var(--space-md);
                font-size: 15px;
            }
        }

        /* ===== SELECTION STYLES ===== */
        ::selection {
            background: var(--primary-200);
            color: var(--primary-900);
        }

        /* ===== FOCUS STYLES (Accessibility) ===== */
        button:focus-visible,
        select:focus-visible {
            outline: 2px solid var(--primary-500);
            outline-offset: 2px;
        }

        /* ===== SELECT ELEMENTS ===== */
        select {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23006B75' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 8px center;
            background-size: 16px;
            padding-right: 32px !important;
        }
    </style>
</head>
<body>
    <!-- Delete Confirmation Modal -->
    <div class="modal" id="deleteModal">
        <div class="modal-content">
            <div class="modal-title">Delete Order?</div>
            <div class="modal-text">Are you sure you want to delete this order? This action cannot be undone.</div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-cancel" onclick="closeDeleteModal()">Cancel</button>
                <button class="modal-btn modal-btn-confirm" onclick="confirmDelete()">Yes</button>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="container">
        <!-- Shop Page -->
        <div class="page active" id="shopPage">
            <h1>Shipt Tracker</h1>

            <!-- Order Counter -->
            <div class="order-counter" id="orderCounter">
                <div class="counter-label">Number of Orders</div>
                <div class="counter-controls">
                    <button class="counter-btn" onclick="changeOrderCount(-1)" id="decreaseBtn">âˆ’</button>
                    <div class="counter-value" id="orderCount">1</div>
                    <button class="counter-btn" onclick="changeOrderCount(1)" id="increaseBtn">+</button>
                </div>
            </div>

            <!-- Current Timer Display -->
            <div class="timer-display">
                <div class="timer-label" id="timerLabel">Ready to Start</div>
                <div class="timer-value" id="timerValue">00:00:00</div>
            </div>

            <!-- Status Display (hidden initially) -->
            <div class="status-display hidden" id="statusDisplay">
                <div class="status-text" id="statusText"></div>
                <div class="status-subtext" id="statusSubtext"></div>
            </div>

            <!-- Action Buttons -->
            <div id="actionButtons">
                <button class="action-btn btn-primary" onclick="startHeadingToStore()" id="headToStoreBtn">
                    Head to Store
                </button>
                <div class="messages-wrapper">
                    <div class="messages-tabs">
                        <button class="messages-tab active" onclick="switchMessageTab('intro')">Intro</button>
                        <button class="messages-tab" onclick="switchMessageTab('finished')">Finished Shopping</button>
                        <button class="messages-tab" onclick="switchMessageTab('delivered')">Delivered</button>
                    </div>
                    <div class="messages-container active" id="tab-intro">
                        <div class="message-box">
                            <button class="copy-btn" onclick="copyMessage(this)">Copy</button>
                            <div class="message-text">Hi I started shopping your order</div>
                        </div>
                    </div>
                    <div class="messages-container" id="tab-finished">
                        <div class="message-box">
                            <button class="copy-btn" onclick="copyMessage(this)">Copy</button>
                            <div class="message-text">I'm done shopping for your order</div>
                        </div>
                    </div>
                    <div class="messages-container" id="tab-delivered">
                        <div class="message-box">
                            <button class="copy-btn" onclick="copyMessage(this)">Copy</button>
                            <div class="message-text">Have a nice day :)</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Past Orders Page -->
        <div class="page" id="historyPage">
            <h1>Past Orders</h1>
            <div id="historyList">
                <div class="empty-history">No trips completed yet</div>
            </div>
        </div>

        <!-- Stats Page -->
<div class="page" id="statsPage">
    <h1>Stats</h1>
    
    <!-- Time Period Selector -->
    <div style="display: none; background: #f8f9fa; border-radius: 12px; padding: 20px; margin-bottom: 25px;">
        <label style="display: block; font-size: 14px; color: #666; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; text-align: center;">
            Time Period
        </label>
        <select id="statsPeriod" onchange="updateStats()" style="width: 100%; padding: 12px; border: 2px solid #006B75; border-radius: 8px; font-size: 16px; font-weight: bold; color: #333; background: white; cursor: pointer;">
    <option value="today">Today</option>
    <option value="yesterday">Yesterday</option>
    <option value="thisWeek">This Week</option>
    <option value="thisMonth">This Month</option>
    <option value="allTime">All Time</option>
    <option value="custom">Custom</option>
</select>
    </div>
    
    <!-- Stats Content -->
    <div id="statsContent">
        <div class="placeholder-page">
            <div class="placeholder-text">Loading...</div>
        </div>
    </div>
</div>

        <!-- Map Page -->
        <div class="page" id="mapPage">
            <h1>Map</h1>
            <div class="placeholder-page">
                <div class="placeholder-text">Coming soon...</div>
            </div>
        </div>

        <!-- Settings Page -->
        <div class="page" id="settingsPage">
            <h1>Settings</h1>
            <div class="placeholder-page">
                <div class="placeholder-text">Coming soon...</div>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <div class="nav-item" onclick="showPage('settings')">
            <div class="nav-icon">&#9881;</div>
            <div class="nav-label">Settings</div>
        </div>
        <div class="nav-item" onclick="showPage('map')">
            <div class="nav-icon">&#128205;</div>
            <div class="nav-label">Map</div>
        </div>
        <div class="nav-item shop-btn active" onclick="showPage('shop')">
            <div class="nav-icon">&#128722;</div>
            <div class="nav-label">Shop</div>
        </div>
        <div class="nav-item" onclick="showPage('history')">
            <div class="nav-icon">&#128203;</div>
            <div class="nav-label">Orders</div>
        </div>
        <div class="nav-item" onclick="showPage('stats')">
            <div class="nav-icon">&#128200;</div>
            <div class="nav-label">Stats</div>
        </div>
    </nav>

    <script>
        let tripState = {
            phase: 'idle',
            orderCount: 1,
            startTime: null,
            headingStartTime: null,
            shoppingStartTime: null,
            deliveringStartTime: null,
            currentDelivery: 0,
            deliveryTimes: [],
            durations: {
                heading: 0,
                shopping: 0,
                delivering: 0,
                total: 0
            }
        };

        let timerInterval = null;
        let tripHistory = [];
        let deleteIndex = null;
        let useLocalStorage = false; // Will be set to true if MongoDB is unavailable

        const FOUR_HOURS_MS = 4 * 60 * 60 * 1000; // 4 hours in milliseconds

        // Save current trip state to localStorage
        function saveTripState() {
            if (tripState.phase !== 'idle') {
                const stateToSave = {
                    ...tripState,
                    startTime: tripState.startTime?.getTime(),
                    headingStartTime: tripState.headingStartTime?.getTime(),
                    shoppingStartTime: tripState.shoppingStartTime?.getTime(),
                    deliveringStartTime: tripState.deliveringStartTime?.getTime(),
                    deliveryTimes: tripState.deliveryTimes.map(dt => dt.getTime()),
                    savedAt: new Date().getTime()
                };
                localStorage.setItem('currentTrip', JSON.stringify(stateToSave));
            } else {
                localStorage.removeItem('currentTrip');
            }
        }

        // Restore trip state from localStorage
        function restoreTripState() {
            try {
                const saved = localStorage.getItem('currentTrip');
                if (!saved) return false;

                const state = JSON.parse(saved);
                const now = new Date().getTime();
                const savedAt = state.savedAt || state.startTime;

                // Check if the saved trip is older than 4 hours
                if (savedAt && (now - savedAt > FOUR_HOURS_MS)) {
                    console.log('Saved trip exceeded 4-hour timeout, discarding...');
                    localStorage.removeItem('currentTrip');
                    return false;
                }

                // Restore the trip state
                tripState = {
                    ...state,
                    startTime: state.startTime ? new Date(state.startTime) : null,
                    headingStartTime: state.headingStartTime ? new Date(state.headingStartTime) : null,
                    shoppingStartTime: state.shoppingStartTime ? new Date(state.shoppingStartTime) : null,
                    deliveringStartTime: state.deliveringStartTime ? new Date(state.deliveringStartTime) : null,
                    deliveryTimes: state.deliveryTimes.map(dt => new Date(dt))
                };

                // Restore the UI based on the phase
                restoreUI();
                return true;
            } catch (error) {
                console.error('Error restoring trip state:', error);
                localStorage.removeItem('currentTrip');
                return false;
            }
        }

        // Restore UI based on saved trip state
        function restoreUI() {
            document.getElementById('orderCount').textContent = tripState.orderCount;

            if (tripState.phase === 'heading') {
                document.getElementById('timerLabel').textContent = 'Heading to Store';
                document.getElementById('actionButtons').innerHTML = `
                    <button class="action-btn btn-success" onclick="startShopping()">
                        Start Shopping
                    </button>
                    <div class="messages-wrapper">
                        <div class="messages-tabs">
                            <button class="messages-tab active" onclick="switchMessageTab('intro')">Intro</button>
                            <button class="messages-tab" onclick="switchMessageTab('finished')">Finished Shopping</button>
                            <button class="messages-tab" onclick="switchMessageTab('delivered')">Delivered</button>
                        </div>
                        <div class="messages-container active" id="tab-intro">
                            <div class="message-box">
                                <button class="copy-btn" onclick="copyMessage(this)">Copy</button>
                                <div class="message-text">Hi I started shopping your order</div>
                            </div>
                        </div>
                        <div class="messages-container" id="tab-finished">
                            <div class="message-box">
                                <button class="copy-btn" onclick="copyMessage(this)">Copy</button>
                                <div class="message-text">I'm done shopping for your order</div>
                            </div>
                        </div>
                        <div class="messages-container" id="tab-delivered">
                            <div class="message-box">
                                <button class="copy-btn" onclick="copyMessage(this)">Copy</button>
                                <div class="message-text">Have a nice day :)</div>
                            </div>
                        </div>
                    </div>
                `;
                startTimer();
            } else if (tripState.phase === 'shopping') {
                document.getElementById('timerLabel').textContent = `Shopping for ${tripState.orderCount} Order${tripState.orderCount > 1 ? 's' : ''}`;
                document.getElementById('actionButtons').innerHTML = `
                    <button class="action-btn btn-success" onclick="completeShopping()">
                        Shopping Complete
                    </button>
                    <div class="messages-wrapper">
                        <div class="messages-tabs">
                            <button class="messages-tab active" onclick="switchMessageTab('intro')">Intro</button>
                            <button class="messages-tab" onclick="switchMessageTab('finished')">Finished Shopping</button>
                            <button class="messages-tab" onclick="switchMessageTab('delivered')">Delivered</button>
                        </div>
                        <div class="messages-container active" id="tab-intro">
                            <div class="message-box">
                                <button class="copy-btn" onclick="copyMessage(this)">Copy</button>
                                <div class="message-text">Hi I started shopping your order</div>
                            </div>
                        </div>
                        <div class="messages-container" id="tab-finished">
                            <div class="message-box">
                                <button class="copy-btn" onclick="copyMessage(this)">Copy</button>
                                <div class="message-text">I'm done shopping for your order</div>
                            </div>
                        </div>
                        <div class="messages-container" id="tab-delivered">
                            <div class="message-box">
                                <button class="copy-btn" onclick="copyMessage(this)">Copy</button>
                                <div class="message-text">Have a nice day :)</div>
                            </div>
                        </div>
                    </div>
                `;
                startTimer();
            } else if (tripState.phase === 'delivering') {
                updateDeliveryUI();
                startTimer();
            }

            // Only disable order count buttons during delivery phase
            if (tripState.phase === 'delivering') {
                document.getElementById('decreaseBtn').disabled = true;
                document.getElementById('increaseBtn').disabled = true;
            } else {
                document.getElementById('decreaseBtn').disabled = false;
                document.getElementById('increaseBtn').disabled = false;
            }
        }

        // Storage functions with localStorage fallback
        const storage = {
            async saveOrder(trip) {
                if (useLocalStorage) {
                    const orders = JSON.parse(localStorage.getItem('shipOrders') || '[]');
                    orders.unshift(trip);
                    localStorage.setItem('shipOrders', JSON.stringify(orders));
                    return { success: true };
                }

                try {
                    const response = await fetch('/api/save-order', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(trip)
                    });
                    const data = await response.json();
                    if (!data.success) throw new Error('Save failed');
                    return data;
                } catch (error) {
                    console.log('MongoDB unavailable, switching to localStorage');
                    useLocalStorage = true;
                    return this.saveOrder(trip);
                }
            },

            async loadOrders() {
                if (useLocalStorage) {
                    const orders = JSON.parse(localStorage.getItem('shipOrders') || '[]');
                    return { success: true, orders };
                }

                try {
                    const controller = new AbortController();
                    const timeout = setTimeout(() => controller.abort(), 2000); // 2 second timeout

                    const response = await fetch('/api/orders', { signal: controller.signal });
                    clearTimeout(timeout);

                    const data = await response.json();
                    if (!data.success) throw new Error('Load failed');
                    return data;
                } catch (error) {
                    console.log('MongoDB unavailable, switching to localStorage');
                    useLocalStorage = true;
                    return this.loadOrders();
                }
            },

            async deleteOrder(index) {
                if (useLocalStorage) {
                    const orders = JSON.parse(localStorage.getItem('shipOrders') || '[]');
                    orders.splice(index, 1);
                    localStorage.setItem('shipOrders', JSON.stringify(orders));
                    return { success: true, orders };
                }

                try {
                    const response = await fetch('/api/delete-order', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ index })
                    });
                    const data = await response.json();
                    if (!data.success) throw new Error('Delete failed');
                    return data;
                } catch (error) {
                    console.log('MongoDB unavailable, switching to localStorage');
                    useLocalStorage = true;
                    return this.deleteOrder(index);
                }
            }
        };

        // Navigation functions
        function showPage(pageName) {
            // Remove active class from all pages
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });

            // Remove active class from all nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });

            const pages = {
                'settings': { element: 'settingsPage', navIndex: 0 },
                'map': { element: 'mapPage', navIndex: 1 },
                'shop': { element: 'shopPage', navIndex: 2 },
                'history': { element: 'historyPage', navIndex: 3 },
                'stats': { element: 'statsPage', navIndex: 4 }
            };

            if (pages[pageName]) {
                // Show the selected page
                document.getElementById(pages[pageName].element).classList.add('active');

                // Mark the nav item as active
                document.querySelectorAll('.nav-item')[pages[pageName].navIndex].classList.add('active');

                // Special handling for history page
                if (pageName === 'history') {
                    displayHistory();
                }

                // Auto-show today's timeline when entering Stats page
                if (pageName === 'stats') {
                    document.getElementById('statsPeriod').value = 'today';
                    setTimeout(() => showStatsView(), 50);
                }
            }
        }

        // Delete modal functions
        function showDeleteModal(index) {
            deleteIndex = index;
            document.getElementById('deleteModal').classList.add('show');
        }

        function closeDeleteModal() {
            deleteIndex = null;
            document.getElementById('deleteModal').classList.remove('show');
        }

        function confirmDelete() {
            if (deleteIndex !== null) {
                storage.deleteOrder(deleteIndex)
                    .then(data => {
                        if (data.success && data.orders) {
                            tripHistory = data.orders.map(trip => ({
                                ...trip,
                                timestamp: new Date(trip.timestamp)
                            }));
                            displayHistory();
                            closeDeleteModal();
                        }
                    })
                    .catch(error => {
                        console.error('Error deleting order:', error);
                        alert('Failed to delete order');
                    });
            }
        }

        // Order counter functions
        function changeOrderCount(delta) {
            const newCount = tripState.orderCount + delta;
            if (newCount >= 1 && newCount <= 6) {
                tripState.orderCount = newCount;
                document.getElementById('orderCount').textContent = newCount;

                // Update timer label if in shopping phase
                if (tripState.phase === 'shopping') {
                    document.getElementById('timerLabel').textContent = `Shopping for ${newCount} Order${newCount > 1 ? 's' : ''}`;
                }

                // Save state if order is in progress
                if (tripState.phase !== 'idle') {
                    saveTripState();
                }
            }
        }

        // Phase 1: Head to Store
        function startHeadingToStore() {
            tripState.phase = 'heading';
            tripState.startTime = new Date();
            tripState.headingStartTime = new Date();

            document.getElementById('timerLabel').textContent = 'Heading to Store';
            document.getElementById('actionButtons').innerHTML = `
                <button class="action-btn btn-success" onclick="startShopping()">
                    Start Shopping
                </button>
                <div class="messages-wrapper">
                    <div class="messages-tabs">
                        <button class="messages-tab active" onclick="switchMessageTab('intro')">Intro</button>
                        <button class="messages-tab" onclick="switchMessageTab('finished')">Finished Shopping</button>
                        <button class="messages-tab" onclick="switchMessageTab('delivered')">Delivered</button>
                    </div>
                    <div class="messages-container active" id="tab-intro">
                        <div class="message-box">
                            <button class="copy-btn" onclick="copyMessage(this)">Copy</button>
                            <div class="message-text">Hi I started shopping your order</div>
                        </div>
                    </div>
                    <div class="messages-container" id="tab-finished">
                        <div class="message-box">
                            <button class="copy-btn" onclick="copyMessage(this)">Copy</button>
                            <div class="message-text">I'm done shopping for your order</div>
                        </div>
                    </div>
                    <div class="messages-container" id="tab-delivered">
                        <div class="message-box">
                            <button class="copy-btn" onclick="copyMessage(this)">Copy</button>
                            <div class="message-text">Have a nice day :)</div>
                        </div>
                    </div>
                </div>
            `;

            startTimer();
            saveTripState();
        }

        // Switch between message tabs
        function switchMessageTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.messages-tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');

            // Update tab content
            document.querySelectorAll('.messages-container').forEach(container => container.classList.remove('active'));
            document.getElementById('tab-' + tabName).classList.add('active');
        }

        // Copy message to clipboard
        function copyMessage(btn) {
            const messageBox = btn.closest('.message-box');
            const text = messageBox.querySelector('.message-text').textContent;

            navigator.clipboard.writeText(text).then(() => {
                btn.textContent = 'Copied!';
                btn.classList.add('copied');
                setTimeout(() => {
                    btn.textContent = 'Copy';
                    btn.classList.remove('copied');
                }, 2000);
            });
        }

        // Phase 2: Shopping
        function startShopping() {
            const now = new Date();
            tripState.phase = 'shopping';
            tripState.durations.heading = Math.floor((now - tripState.headingStartTime) / 1000);
            tripState.shoppingStartTime = now;

            document.getElementById('timerLabel').textContent = `Shopping for ${tripState.orderCount} Order${tripState.orderCount > 1 ? 's' : ''}`;
            document.getElementById('actionButtons').innerHTML = `
                <button class="action-btn btn-success" onclick="completeShopping()">
                    Shopping Complete
                </button>
                <div class="messages-wrapper">
                    <div class="messages-tabs">
                        <button class="messages-tab active" onclick="switchMessageTab('intro')">Intro</button>
                        <button class="messages-tab" onclick="switchMessageTab('finished')">Finished Shopping</button>
                        <button class="messages-tab" onclick="switchMessageTab('delivered')">Delivered</button>
                    </div>
                    <div class="messages-container active" id="tab-intro">
                        <div class="message-box">
                            <button class="copy-btn" onclick="copyMessage(this)">Copy</button>
                            <div class="message-text">Hi I started shopping your order</div>
                        </div>
                    </div>
                    <div class="messages-container" id="tab-finished">
                        <div class="message-box">
                            <button class="copy-btn" onclick="copyMessage(this)">Copy</button>
                            <div class="message-text">I'm done shopping for your order</div>
                        </div>
                    </div>
                    <div class="messages-container" id="tab-delivered">
                        <div class="message-box">
                            <button class="copy-btn" onclick="copyMessage(this)">Copy</button>
                            <div class="message-text">Have a nice day :)</div>
                        </div>
                    </div>
                </div>
            `;

            resetTimer();
            saveTripState();
        }

        // Phase 3: Start Deliveries
        function completeShopping() {
            const now = new Date();
            tripState.phase = 'delivering';
            tripState.durations.shopping = Math.floor((now - tripState.shoppingStartTime) / 1000);
            tripState.deliveringStartTime = now;
            tripState.currentDelivery = 1;

            document.getElementById('decreaseBtn').disabled = true;
            document.getElementById('increaseBtn').disabled = true;

            updateDeliveryUI();
            resetTimer();
            saveTripState();
        }

        // Delivery tracking
        function updateDeliveryUI() {
            const deliveryNum = tripState.currentDelivery;
            const totalOrders = tripState.orderCount;

            document.getElementById('timerLabel').textContent = `Delivery ${deliveryNum} of ${totalOrders}`;
            
            document.getElementById('statusDisplay').classList.remove('hidden');
            document.getElementById('statusText').textContent = `Delivery ${deliveryNum} in Progress`;
            document.getElementById('statusSubtext').textContent = `${totalOrders - deliveryNum} remaining`;

            document.getElementById('actionButtons').innerHTML = `
                <button class="action-btn btn-success" onclick="completeDelivery()">
                    Delivery ${deliveryNum} Complete
                </button>
                <div class="messages-wrapper">
                    <div class="messages-tabs">
                        <button class="messages-tab active" onclick="switchMessageTab('intro')">Intro</button>
                        <button class="messages-tab" onclick="switchMessageTab('finished')">Finished Shopping</button>
                        <button class="messages-tab" onclick="switchMessageTab('delivered')">Delivered</button>
                    </div>
                    <div class="messages-container active" id="tab-intro">
                        <div class="message-box">
                            <button class="copy-btn" onclick="copyMessage(this)">Copy</button>
                            <div class="message-text">Hi I started shopping your order</div>
                        </div>
                    </div>
                    <div class="messages-container" id="tab-finished">
                        <div class="message-box">
                            <button class="copy-btn" onclick="copyMessage(this)">Copy</button>
                            <div class="message-text">I'm done shopping for your order</div>
                        </div>
                    </div>
                    <div class="messages-container" id="tab-delivered">
                        <div class="message-box">
                            <button class="copy-btn" onclick="copyMessage(this)">Copy</button>
                            <div class="message-text">Have a nice day :)</div>
                        </div>
                    </div>
                </div>
            `;
            saveTripState();
        }

        function completeDelivery() {
            const now = new Date();
            tripState.deliveryTimes.push(now);
            tripState.currentDelivery++;

            if (tripState.currentDelivery <= tripState.orderCount) {
                updateDeliveryUI();
                resetTimer();
                saveTripState();
            } else {
                completeTrip();
            }
        }

        // Complete entire trip
function completeTrip() {
    const now = new Date();
    tripState.durations.delivering = Math.floor((now - tripState.deliveringStartTime) / 1000);
    tripState.durations.total = Math.floor((now - tripState.startTime) / 1000);

    stopTimer();

    // Calculate individual delivery times from the deliveryTimes array
    const individualDeliveryDurations = [];
    let previousTime = tripState.deliveringStartTime;
    
    for (let i = 0; i < tripState.deliveryTimes.length; i++) {
        const deliveryDuration = Math.floor((tripState.deliveryTimes[i] - previousTime) / 1000);
        individualDeliveryDurations.push(deliveryDuration);
        previousTime = tripState.deliveryTimes[i];
    }

    const trip = {
        timestamp: now.toISOString(),
        orderCount: tripState.orderCount,
        durations: { ...tripState.durations },
        individualDeliveries: individualDeliveryDurations
    };

    storage.saveOrder(trip)
        .then(data => {
            console.log('Trip saved:', data);
            tripHistory.unshift({ ...trip, timestamp: now });
            displayHistory();
            resetTrip();
        })
        .catch(error => {
            console.error('Error saving trip:', error);
            alert('Failed to save trip. Please try again.');
        });
}

        // Timer functions
        function startTimer() {
            stopTimer();
            timerInterval = setInterval(updateTimer, 1000);
            updateTimer();
        }

        function updateTimer() {
            let startTime;
            if (tripState.phase === 'heading') {
                startTime = tripState.headingStartTime;
            } else if (tripState.phase === 'shopping') {
                startTime = tripState.shoppingStartTime;
            } else if (tripState.phase === 'delivering') {
                startTime = tripState.deliveringStartTime;
            }

            if (startTime) {
                const elapsed = Math.floor((new Date() - startTime) / 1000);
                document.getElementById('timerValue').textContent = formatDuration(elapsed);
            }
        }

        function resetTimer() {
            document.getElementById('timerValue').textContent = '00:00:00';
            startTimer();
        }

        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }

        // Helper: Format duration for timer (HH:MM:SS)
        function formatDuration(seconds) {
            const hrs = Math.floor(seconds / 3600);
            const mins = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            return `${String(hrs).padStart(2, '0')}:${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        }

        // Reset for new trip
        function resetTrip() {
            tripState = {
                phase: 'idle',
                orderCount: 1,
                startTime: null,
                headingStartTime: null,
                shoppingStartTime: null,
                deliveringStartTime: null,
                currentDelivery: 0,
                deliveryTimes: [],
                durations: {
                    heading: 0,
                    shopping: 0,
                    delivering: 0,
                    total: 0
                }
            };

            document.getElementById('orderCount').textContent = '1';
            document.getElementById('decreaseBtn').disabled = false;
            document.getElementById('increaseBtn').disabled = false;
            document.getElementById('timerLabel').textContent = 'Ready to Start';
            document.getElementById('timerValue').textContent = '00:00:00';
            document.getElementById('statusDisplay').classList.add('hidden');
            document.getElementById('actionButtons').innerHTML = `
                <button class="action-btn btn-primary" onclick="startHeadingToStore()">
                    Head to Store
                </button>
                <div class="messages-wrapper">
                    <div class="messages-tabs">
                        <button class="messages-tab active" onclick="switchMessageTab('intro')">Intro</button>
                        <button class="messages-tab" onclick="switchMessageTab('finished')">Finished Shopping</button>
                        <button class="messages-tab" onclick="switchMessageTab('delivered')">Delivered</button>
                    </div>
                    <div class="messages-container active" id="tab-intro">
                        <div class="message-box">
                            <button class="copy-btn" onclick="copyMessage(this)">Copy</button>
                            <div class="message-text">Hi I started shopping your order</div>
                        </div>
                    </div>
                    <div class="messages-container" id="tab-finished">
                        <div class="message-box">
                            <button class="copy-btn" onclick="copyMessage(this)">Copy</button>
                            <div class="message-text">I'm done shopping for your order</div>
                        </div>
                    </div>
                    <div class="messages-container" id="tab-delivered">
                        <div class="message-box">
                            <button class="copy-btn" onclick="copyMessage(this)">Copy</button>
                            <div class="message-text">Have a nice day :)</div>
                        </div>
                    </div>
                </div>
            `;
            saveTripState(); // Clear saved state since we're back to idle
        }

        // Display history
        // Display history
function displayHistory() {
    const historyList = document.getElementById('historyList');
    
    if (tripHistory.length === 0) {
        historyList.innerHTML = '<div class="empty-history">No trips completed yet</div>';
        return;
    }

    historyList.innerHTML = tripHistory.map((trip, index) => {
        const totalMinutes = Math.floor(trip.durations.total / 60);
        const totalTimeDisplay = formatTimeDisplay(trip.durations.total);
        
        return `
            <div class="history-item-compact" onclick="showOrderDetail(${index})">
                <button class="delete-btn-compact" onclick="event.stopPropagation(); showDeleteModal(${index})">Ã—</button>
                
                <div class="compact-header">
                    <div class="compact-order-info">
                        Order #${tripHistory.length - index} â€¢ ${trip.orderCount} Order${trip.orderCount > 1 ? 's' : ''}
                    </div>
                    <div class="compact-date">
                        ${formatCompactDate(trip.timestamp)}
                    </div>
                </div>
                
                <div class="compact-stats">
                    <div class="compact-stat-box">
                        <div class="compact-stat-label">Orders</div>
                        <div class="compact-stat-value">${trip.orderCount}</div>
                    </div>
                    <div class="compact-stat-box">
                        <div class="compact-stat-label">Total Time</div>
                        <div class="compact-stat-value ${totalMinutes > 360 ? 'too-long' : ''}">${totalTimeDisplay}</div>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}
// Show order detail
function showOrderDetail(index, source = 'orders') {
    const trip = tripHistory[index];
    const orderNumber = tripHistory.length - index;
    const totalSeconds = trip.durations.total;
    
    // Calculate percentages
    const headingPercent = (trip.durations.heading / totalSeconds) * 100;
    const shoppingPercent = (trip.durations.shopping / totalSeconds) * 100;
    const deliveringPercent = (trip.durations.delivering / totalSeconds) * 100;
    
    // Calculate per-delivery time (approximate)
    const timePerDelivery = trip.durations.delivering / trip.orderCount;
    
    // Build the visual bar segments
    let barSegments = `
        <div id="segment-heading" 
             onclick="highlightSegment('heading')"
             style="background: #667eea; width: ${headingPercent}%; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 12px;">
            ${headingPercent > 10 ? 'Driving' : ''}
        </div>
        <div id="segment-shopping" 
             onclick="highlightSegment('shopping')"
             style="background: #11998e; width: ${shoppingPercent}%; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 12px;">
            ${shoppingPercent > 10 ? 'Shopping' : ''}
        </div>
    `;
    
    // Add individual delivery segments
const deliveryColors = ['#f45c43', '#ff6b6b', '#ff8787', '#ffa5a5', '#ffc1c1', '#ffd4d4'];

for (let i = 0; i < trip.orderCount; i++) {
    const color = deliveryColors[i % deliveryColors.length];
    
    // Use actual individual delivery time if available
    const actualDeliveryTime = trip.individualDeliveries && trip.individualDeliveries[i] 
        ? trip.individualDeliveries[i] 
        : Math.floor(timePerDelivery);
    
    const thisDeliveryPercent = (actualDeliveryTime / totalSeconds) * 100;
    
    barSegments += `
        <div id="segment-delivery-${i}" 
             onclick="highlightSegment('delivery-${i}')"
             style="background: ${color}; width: ${thisDeliveryPercent}%; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 12px;">
            ${thisDeliveryPercent > 8 ? `D${i + 1}` : ''}
        </div>
    `;
}
    
    // Build breakdown list
    let breakdownItems = `
        <div id="breakdown-heading" 
             onclick="highlightSegment('heading')"
             style="background: white; padding: 12px 15px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: all 0.3s ease;">
            <div style="display: flex; align-items: center; gap: 10px;">
                <div style="width: 12px; height: 12px; background: #667eea; border-radius: 3px;"></div>
                <span style="font-weight: bold; color: #333;">Driving to Store</span>
            </div>
            <div style="display: flex; gap: 15px; align-items: center;">
                <span style="color: #666;">${formatTimeDisplay(trip.durations.heading)}</span>
                <span style="color: #667eea; font-weight: bold; min-width: 45px; text-align: right;">${headingPercent.toFixed(1)}%</span>
            </div>
        </div>
        
        <div id="breakdown-shopping" 
             onclick="highlightSegment('shopping')"
             style="background: white; padding: 12px 15px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: all 0.3s ease;">
            <div style="display: flex; align-items: center; gap: 10px;">
                <div style="width: 12px; height: 12px; background: #11998e; border-radius: 3px;"></div>
                <span style="font-weight: bold; color: #333;">Shopping</span>
            </div>
            <div style="display: flex; gap: 15px; align-items: center;">
                <span style="color: #666;">${formatTimeDisplay(trip.durations.shopping)}</span>
                <span style="color: #11998e; font-weight: bold; min-width: 45px; text-align: right;">${shoppingPercent.toFixed(1)}%</span>
            </div>
        </div>
    `;
    
    // Add individual delivery breakdown items
for (let i = 0; i < trip.orderCount; i++) {
    const color = deliveryColors[i % deliveryColors.length];
    
    // Use actual individual delivery time if available, otherwise fall back to average
    const actualDeliveryTime = trip.individualDeliveries && trip.individualDeliveries[i] 
        ? trip.individualDeliveries[i] 
        : Math.floor(timePerDelivery);
    
    const deliveryPercent = (actualDeliveryTime / totalSeconds) * 100;
    
    breakdownItems += `
        <div id="breakdown-delivery-${i}" 
             onclick="highlightSegment('delivery-${i}')"
             style="background: white; padding: 12px 15px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: all 0.3s ease;">
            <div style="display: flex; align-items: center; gap: 10px;">
                <div style="width: 12px; height: 12px; background: ${color}; border-radius: 3px;"></div>
                <span style="font-weight: bold; color: #333;">Delivery ${i + 1}</span>
            </div>
            <div style="display: flex; gap: 15px; align-items: center;">
                <span style="color: #666;">${formatTimeDisplay(actualDeliveryTime)}</span>
                <span style="color: ${color}; font-weight: bold; min-width: 45px; text-align: right;">${deliveryPercent.toFixed(1)}%</span>
            </div>
        </div>
    `;
}
    
    const detailHTML = `
    <div style="padding: 20px 0;">
        <!-- Header -->
        <div style="text-align: center; margin-bottom: 30px;">
            <div style="font-size: 16px; font-weight: bold; color: #667eea; margin-bottom: 10px;">
                Order #${orderNumber} â€¢ ${trip.orderCount} Order${trip.orderCount > 1 ? 's' : ''}
            </div>
            <div style="font-size: 36px; font-weight: bold; color: #333; margin-bottom: 10px;">
                ${formatTimeDisplay(totalSeconds)}
            </div>
            <div style="font-size: 14px; color: #666;">
                ${formatDetailDate(new Date(trip.timestamp.getTime() - (totalSeconds * 1000)))} - ${formatDetailDate(trip.timestamp)}
            </div>
        </div>
            
            <!-- Interactive Chart -->
            <div style="background: #f8f9fa; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                <div style="display: flex; height: 60px; border-radius: 8px; overflow: hidden; margin-bottom: 20px; cursor: pointer;">
                    ${barSegments}
                </div>
                
                <!-- Breakdown List -->
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    ${breakdownItems}
                </div>
            </div>

            <!-- Back Button(s) -->
            ${source === 'stats' ? `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <button class="action-btn btn-primary" onclick="backToOrdersList()" style="padding: 12px;">
                        â† Back to Orders
                    </button>
                    <button class="action-btn btn-primary" onclick="showPage('stats')" style="padding: 12px;">
                        â† Back to Stats
                    </button>
                </div>
            ` : `
                <button class="action-btn btn-primary" onclick="backToOrdersList()">
                    â† Back to Orders
                </button>
            `}
        </div>
    `;

    document.getElementById('historyList').innerHTML = detailHTML;
}

// Highlight segment interaction
function highlightSegment(segmentName) {
    // Reset all segments
    const allElements = document.querySelectorAll('[id^="segment-"], [id^="breakdown-"]');
    allElements.forEach(el => {
        if (el.id.startsWith('segment-')) {
            el.style.opacity = '0.5';
            el.style.transform = 'scale(1)';
        } else if (el.id.startsWith('breakdown-')) {
            el.style.background = 'white';
            el.style.transform = 'scale(1)';
        }
    });
    
    // Highlight selected
    const selectedSegment = document.getElementById(`segment-${segmentName}`);
    const selectedBreakdown = document.getElementById(`breakdown-${segmentName}`);
    
    if (selectedSegment) {
        selectedSegment.style.opacity = '1';
        selectedSegment.style.transform = 'scaleY(1.1)';
    }
    
    if (selectedBreakdown) {
        selectedBreakdown.style.background = '#f0f4ff';
        selectedBreakdown.style.transform = 'scale(1.02)';
    }
    
    // Auto-reset after 2 seconds
    setTimeout(() => {
        allElements.forEach(el => {
            if (el.id.startsWith('segment-')) {
                el.style.opacity = '1';
                el.style.transform = 'scale(1)';
            } else if (el.id.startsWith('breakdown-')) {
                el.style.background = 'white';
                el.style.transform = 'scale(1)';
            }
        });
    }, 2000);
}

// Back to orders list
function backToOrdersList() {
    displayHistory();
}
// Update stats based on selected period (called when dropdown changes)
function updateStats() {
    showStatsView();
}

// Toggle the time breakdown visibility
function toggleTimeBreakdown() {
    const breakdown = document.getElementById('timeBreakdown');
    const toggle = document.getElementById('timeBreakdownToggle');

    if (breakdown.style.display === 'none' || breakdown.style.display === '') {
        breakdown.style.display = 'grid';
        toggle.style.transform = 'rotate(180deg)';
    } else {
        breakdown.style.display = 'none';
        toggle.style.transform = 'rotate(0deg)';
    }
}

// Main function to show stats view based on selected period
function showStatsView() {
    const inlineDropdown = document.getElementById('statsPeriodInline');
    const originalDropdown = document.getElementById('statsPeriod');
    const period = inlineDropdown ? inlineDropdown.value : originalDropdown.value;
    const statsContent = document.getElementById('statsContent');

    // Only Today and Yesterday are fully implemented
    // Show "Coming soon" for other periods
    if (period === 'thisWeek' || period === 'thisMonth' || period === 'allTime' || period === 'custom') {
        statsContent.innerHTML = `
            <div>
                <!-- Header Row: Period Selector (same as other views) -->
                <div style="display: flex; align-items: center; justify-content: flex-end; gap: 15px; margin-bottom: 15px;">
                    <select id="statsPeriodInline" onchange="updateStats()" style="padding: 8px 12px; border: 2px solid #006B75; border-radius: 8px; font-size: 14px; font-weight: bold; color: #333; background: white; cursor: pointer;">
                        <option value="today" ${period === 'today' ? 'selected' : ''}>Today</option>
                        <option value="yesterday" ${period === 'yesterday' ? 'selected' : ''}>Yesterday</option>
                        <option value="thisWeek" ${period === 'thisWeek' ? 'selected' : ''}>This Week</option>
                        <option value="thisMonth" ${period === 'thisMonth' ? 'selected' : ''}>This Month</option>
                        <option value="allTime" ${period === 'allTime' ? 'selected' : ''}>All Time</option>
                        <option value="custom" ${period === 'custom' ? 'selected' : ''}>Custom</option>
                    </select>
                </div>

                <div class="placeholder-page">
                    <div class="placeholder-text">Coming soon...</div>
                    <div style="font-size: 14px; color: #999; margin-top: 10px;">
                        This time period is not yet implemented.
                    </div>
                </div>
            </div>
        `;
        return;
    }

    // For Today and Yesterday, show the timeline graph directly
    const filteredTrips = filterTripsByPeriod(period);

    if (filteredTrips.length === 0) {
        statsContent.innerHTML = `
            <div>
                <!-- Header Row: Period Selector -->
                <div style="display: flex; align-items: center; justify-content: flex-end; gap: 15px; margin-bottom: 15px;">
                    <select id="statsPeriodInline" onchange="updateStats()" style="padding: 8px 12px; border: 2px solid #006B75; border-radius: 8px; font-size: 14px; font-weight: bold; color: #333; background: white; cursor: pointer;">
                        <option value="today" ${period === 'today' ? 'selected' : ''}>Today</option>
                        <option value="yesterday" ${period === 'yesterday' ? 'selected' : ''}>Yesterday</option>
                        <option value="thisWeek" ${period === 'thisWeek' ? 'selected' : ''}>This Week</option>
                        <option value="thisMonth" ${period === 'thisMonth' ? 'selected' : ''}>This Month</option>
                        <option value="allTime" ${period === 'allTime' ? 'selected' : ''}>All Time</option>
                        <option value="custom" ${period === 'custom' ? 'selected' : ''}>Custom</option>
                    </select>
                </div>

                <div class="placeholder-page">
                    <div class="placeholder-text">No orders found for ${period === 'today' ? 'today' : 'yesterday'}</div>
                </div>
            </div>
        `;
        return;
    }

    // Show the timeline view directly (same as showOrdersTimeline but without back button)
    showOrdersTimelineMain(period);
}

// Show orders timeline as the main view (for Today/Yesterday)
function showOrdersTimelineMain(period) {
    const statsContent = document.getElementById('statsContent');
    const filteredTrips = filterTripsByPeriod(period);

    // Sort trips by start time
    const sortedTrips = [...filteredTrips].sort((a, b) => {
        const aStart = new Date(a.timestamp).getTime() - (a.durations.total * 1000);
        const bStart = new Date(b.timestamp).getTime() - (b.durations.total * 1000);
        return aStart - bStart;
    });

    // Calculate totals for each phase
    const totalDriving = filteredTrips.reduce((sum, trip) => sum + trip.durations.heading, 0);
    const totalShopping = filteredTrips.reduce((sum, trip) => sum + trip.durations.shopping, 0);
    const totalDelivering = filteredTrips.reduce((sum, trip) => sum + trip.durations.delivering, 0);
    const totalTime = totalDriving + totalShopping + totalDelivering;
    const totalOrders = filteredTrips.reduce((sum, trip) => sum + trip.orderCount, 0);

    // Timeline range: 6 AM to 11:59 PM (18 hours)
    const startHour = 6;
    const endHour = 24; // midnight
    const totalMinutes = (endHour - startHour) * 60; // 1080 minutes

    // Generate hour labels
    let hourLabels = '';
    for (let h = startHour; h <= endHour; h += 3) {
        const displayHour = h > 12 ? h - 12 : (h === 0 ? 12 : h);
        const ampm = h >= 12 && h < 24 ? 'p' : 'a';
        const leftPercent = ((h - startHour) / (endHour - startHour)) * 100;
        hourLabels += `<div style="position: absolute; left: ${leftPercent}%; transform: translateX(-50%); font-size: 10px; color: #999;">${displayHour}${ampm}</div>`;
    }

    // Generate order bars
    let orderBars = '';

    sortedTrips.forEach((trip, index) => {
        const endTime = new Date(trip.timestamp);
        const startTime = new Date(endTime.getTime() - (trip.durations.total * 1000));

        // Calculate position on timeline
        const startMinutes = startTime.getHours() * 60 + startTime.getMinutes();
        const endMinutes = endTime.getHours() * 60 + endTime.getMinutes();

        // Convert to position relative to 6 AM
        const relativeStart = startMinutes - (startHour * 60);
        const relativeEnd = endMinutes - (startHour * 60);

        // Calculate percentages
        const leftPercent = Math.max(0, (relativeStart / totalMinutes) * 100);
        const widthPercent = Math.max(2, ((relativeEnd - relativeStart) / totalMinutes) * 100);

        // Calculate segment widths within the bar
        const totalDuration = trip.durations.total;
        const headingPercent = (trip.durations.heading / totalDuration) * 100;
        const shoppingPercent = (trip.durations.shopping / totalDuration) * 100;
        const deliveringPercent = (trip.durations.delivering / totalDuration) * 100;

        // Build the solid colored bar with centered text
        const barId = `timeline-bar-${index}`;
        const tooltipId = `timeline-tooltip-${index}`;

        orderBars += `
            <div id="${barId}"
                 style="position: absolute; left: ${leftPercent}%; width: ${widthPercent}%; height: 24px; top: ${index * 30}px;
                        display: flex; align-items: center; justify-content: center; border-radius: 4px; cursor: pointer;
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        box-shadow: 0 1px 3px rgba(0,0,0,0.1); transition: all 0.2s ease;
                        color: white; font-weight: bold; font-size: 12px;"
                 onmouseenter="showTimelineTooltip(${index}, event)"
                 onmouseleave="hideTimelineTooltip(${index})"
                 onclick="showTimelineOrderDetail(${index}, '${period}')">
                ${trip.orderCount}
            </div>
            <div id="${tooltipId}"
                 style="display: none; position: absolute; left: ${leftPercent}%; top: ${index * 30 - 75}px;
                        background: white; border-radius: 8px; padding: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                        z-index: 100; min-width: 180px; font-size: 11px;">
                <div style="font-weight: bold; margin-bottom: 6px; color: #333;">
                    ${trip.orderCount} Order${trip.orderCount > 1 ? 's' : ''} - ${formatTimeDisplay(trip.durations.total)}
                </div>
                <div style="display: flex; height: 16px; border-radius: 3px; overflow: hidden; margin-bottom: 6px;">
                    <div style="background: #667eea; width: ${headingPercent}%;"></div>
                    <div style="background: #11998e; width: ${shoppingPercent}%;"></div>
                    <div style="background: #f45c43; width: ${deliveringPercent}%;"></div>
                </div>
                <div style="display: flex; justify-content: space-between; color: #666; font-size: 10px;">
                    <span>Drive ${formatTimeDisplay(trip.durations.heading)}</span>
                    <span>Shop ${formatTimeDisplay(trip.durations.shopping)}</span>
                    <span>Deliver ${formatTimeDisplay(trip.durations.delivering)}</span>
                </div>
            </div>
        `;
    });

    // Calculate required height based on number of orders
    const timelineHeight = Math.max(80, sortedTrips.length * 30);

    statsContent.innerHTML = `
        <div>
            <!-- Header Row: Total Orders + Period Selector -->
            <div style="display: flex; align-items: center; justify-content: space-between; gap: 15px; margin-bottom: 15px;">
                <!-- Total Orders Card -->
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 10px; padding: 15px; text-align: center; flex: 0 0 auto; min-width: 140px;">
                    <div style="font-size: 11px; opacity: 0.9; text-transform: uppercase; letter-spacing: 0.5px;">Total Orders</div>
                    <div style="font-size: 28px; font-weight: bold; margin-top: 5px;">${totalOrders}</div>
                </div>

                <!-- Period Selector (smaller, right-aligned) -->
                <select id="statsPeriodInline" onchange="updateStats()" style="padding: 8px 12px; border: 2px solid #006B75; border-radius: 8px; font-size: 14px; font-weight: bold; color: #333; background: white; cursor: pointer; flex: 0 0 auto;">
                    <option value="today" ${period === 'today' ? 'selected' : ''}>Today</option>
                    <option value="yesterday" ${period === 'yesterday' ? 'selected' : ''}>Yesterday</option>
                    <option value="thisWeek" ${period === 'thisWeek' ? 'selected' : ''}>This Week</option>
                    <option value="thisMonth" ${period === 'thisMonth' ? 'selected' : ''}>This Month</option>
                    <option value="allTime" ${period === 'allTime' ? 'selected' : ''}>All Time</option>
                    <option value="custom" ${period === 'custom' ? 'selected' : ''}>Custom</option>
                </select>
            </div>

            <!-- Time Working Card with Collapsible Breakdown -->
            <div style="margin-bottom: 15px;">
                <div style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; border-radius: 10px; padding: 15px; position: relative; cursor: pointer;" onclick="toggleTimeBreakdown()">
                    <div style="font-size: 11px; opacity: 0.9; text-transform: uppercase; letter-spacing: 0.5px; text-align: center;">Time Working</div>
                    <div style="font-size: 28px; font-weight: bold; margin-top: 5px; text-align: center;">${formatTimeDisplay(totalTime, false)}</div>
                    <!-- Dropdown toggle button -->
                    <div style="position: absolute; top: 10px; right: 10px; font-size: 16px; transition: transform 0.3s ease;" id="timeBreakdownToggle">
                        â–¼
                    </div>
                </div>

                <!-- Collapsible Phase Breakdown -->
                <div id="timeBreakdown" style="display: none; margin-top: 10px; grid-template-columns: 1fr 1fr 1fr; gap: 8px;">
                    <div style="background: #667eea; color: white; border-radius: 8px; padding: 12px; text-align: center;">
                        <div style="font-size: 10px; opacity: 0.9; text-transform: uppercase; letter-spacing: 0.5px;">Driving</div>
                        <div style="font-size: 16px; font-weight: bold; margin-top: 4px;">${formatTimeDisplay(totalDriving, false)}</div>
                    </div>
                    <div style="background: #11998e; color: white; border-radius: 8px; padding: 12px; text-align: center;">
                        <div style="font-size: 10px; opacity: 0.9; text-transform: uppercase; letter-spacing: 0.5px;">Shopping</div>
                        <div style="font-size: 16px; font-weight: bold; margin-top: 4px;">${formatTimeDisplay(totalShopping, false)}</div>
                    </div>
                    <div style="background: #f45c43; color: white; border-radius: 8px; padding: 12px; text-align: center;">
                        <div style="font-size: 10px; opacity: 0.9; text-transform: uppercase; letter-spacing: 0.5px;">Delivering</div>
                        <div style="font-size: 16px; font-weight: bold; margin-top: 4px;">${formatTimeDisplay(totalDelivering, false)}</div>
                    </div>
                </div>
            </div>

            <!-- Timeline Container -->
            <div style="background: #f8f9fa; border-radius: 10px; padding: 12px; position: relative;">
                <!-- Scrollable wrapper - shows 4 hours at a time -->
                <div style="overflow-x: auto; overflow-y: hidden; -webkit-overflow-scrolling: touch;">
                    <!-- Timeline inner container - 4.5x wider to show all 18 hours -->
                    <div style="width: 450%; min-width: 450%;">
                        <!-- Hour labels -->
                        <div style="position: relative; height: 18px; margin-bottom: 5px;">
                            ${hourLabels}
                        </div>

                        <!-- Timeline grid lines -->
                        <div style="position: relative; height: ${timelineHeight}px; border-left: 1px solid #ddd; border-right: 1px solid #ddd;">
                            <!-- Vertical grid lines every 3 hours -->
                            ${Array.from({length: 7}, (_, i) => {
                                const leftPercent = (i * 3 / 18) * 100;
                                return `<div style="position: absolute; left: ${leftPercent}%; top: 0; bottom: 0; border-left: 1px dashed #e0e0e0;"></div>`;
                            }).join('')}

                            <!-- Order bars -->
                            ${orderBars}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Legend -->
            <div style="display: flex; justify-content: center; gap: 15px; margin-top: 12px; font-size: 11px; color: #666;">
                <div style="display: flex; align-items: center; gap: 5px;">
                    <div style="width: 12px; height: 12px; background: #667eea; border-radius: 2px;"></div>
                    <span>Driving</span>
                </div>
                <div style="display: flex; align-items: center; gap: 5px;">
                    <div style="width: 12px; height: 12px; background: #11998e; border-radius: 2px;"></div>
                    <span>Shopping</span>
                </div>
                <div style="display: flex; align-items: center; gap: 5px;">
                    <div style="width: 12px; height: 12px; background: #f45c43; border-radius: 2px;"></div>
                    <span>Delivering</span>
                </div>
            </div>
        </div>
    `;
}

// Show orders timeline view (legacy - kept for compatibility)
function showOrdersTimeline(period) {
    const statsContent = document.getElementById('statsContent');
    const filteredTrips = filterTripsByPeriod(period);

    // Sort trips by start time
    const sortedTrips = [...filteredTrips].sort((a, b) => {
        const aStart = new Date(a.timestamp).getTime() - (a.durations.total * 1000);
        const bStart = new Date(b.timestamp).getTime() - (b.durations.total * 1000);
        return aStart - bStart;
    });

    // Calculate totals for each phase
    const totalDriving = filteredTrips.reduce((sum, trip) => sum + trip.durations.heading, 0);
    const totalShopping = filteredTrips.reduce((sum, trip) => sum + trip.durations.shopping, 0);
    const totalDelivering = filteredTrips.reduce((sum, trip) => sum + trip.durations.delivering, 0);

    // Timeline range: 6 AM to 11:59 PM (18 hours)
    const startHour = 6;
    const endHour = 24; // midnight
    const totalMinutes = (endHour - startHour) * 60; // 1080 minutes

    // Generate hour labels
    let hourLabels = '';
    for (let h = startHour; h <= endHour; h += 3) {
        const displayHour = h > 12 ? h - 12 : (h === 0 ? 12 : h);
        const ampm = h >= 12 && h < 24 ? 'p' : 'a';
        const leftPercent = ((h - startHour) / (endHour - startHour)) * 100;
        hourLabels += `<div style="position: absolute; left: ${leftPercent}%; transform: translateX(-50%); font-size: 10px; color: #999;">${displayHour}${ampm}</div>`;
    }

    // Generate order bars
    let orderBars = '';

    sortedTrips.forEach((trip, index) => {
        const endTime = new Date(trip.timestamp);
        const startTime = new Date(endTime.getTime() - (trip.durations.total * 1000));

        // Calculate position on timeline
        const startMinutes = startTime.getHours() * 60 + startTime.getMinutes();
        const endMinutes = endTime.getHours() * 60 + endTime.getMinutes();

        // Convert to position relative to 6 AM
        const relativeStart = startMinutes - (startHour * 60);
        const relativeEnd = endMinutes - (startHour * 60);

        // Calculate percentages
        const leftPercent = Math.max(0, (relativeStart / totalMinutes) * 100);
        const widthPercent = Math.max(2, ((relativeEnd - relativeStart) / totalMinutes) * 100);

        // Calculate segment widths within the bar
        const totalDuration = trip.durations.total;
        const headingPercent = (trip.durations.heading / totalDuration) * 100;
        const shoppingPercent = (trip.durations.shopping / totalDuration) * 100;
        const deliveringPercent = (trip.durations.delivering / totalDuration) * 100;

        // Build the solid colored bar with centered text
        const barId = `timeline-bar-${index}`;
        const tooltipId = `timeline-tooltip-${index}`;

        orderBars += `
            <div id="${barId}"
                 style="position: absolute; left: ${leftPercent}%; width: ${widthPercent}%; height: 24px; top: ${index * 30}px;
                        display: flex; align-items: center; justify-content: center; border-radius: 6px; cursor: pointer;
                        background: linear-gradient(135deg, rgba(139, 92, 246, 0.2) 0%, rgba(168, 85, 247, 0.25) 100%);
                        border: 2px solid rgba(139, 92, 246, 0.4);
                        box-shadow: 0 1px 3px rgba(0,0,0,0.08); transition: all 0.2s ease;
                        color: #006B75; font-weight: bold; font-size: 13px;"
                 onmouseenter="showTimelineTooltip(${index}, event)"
                 onmouseleave="hideTimelineTooltip(${index})"
                 onclick="showTimelineOrderDetail(${index}, '${period}')">
                ${trip.orderCount}
            </div>
            <div id="${tooltipId}"
                 style="display: none; position: absolute; left: ${leftPercent}%; top: ${index * 30 - 75}px;
                        background: white; border-radius: 12px; padding: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.15);
                        z-index: 100; min-width: 180px; font-size: 11px; border: 1px solid #e5e7eb;">
                <div style="font-weight: bold; margin-bottom: 8px; color: #006B75;">
                    ${trip.orderCount} Order${trip.orderCount > 1 ? 's' : ''} - ${formatTimeDisplay(trip.durations.total)}
                </div>
                <div style="display: flex; height: 16px; border-radius: 4px; overflow: hidden; margin-bottom: 8px;">
                    <div style="background: #006B75; width: ${headingPercent}%;"></div>
                    <div style="background: #34d399; width: ${shoppingPercent}%;"></div>
                    <div style="background: #8b5cf6; width: ${deliveringPercent}%;"></div>
                </div>
                <div style="display: flex; justify-content: space-between; color: #666; font-size: 10px;">
                    <span>Drive ${formatTimeDisplay(trip.durations.heading)}</span>
                    <span>Shop ${formatTimeDisplay(trip.durations.shopping)}</span>
                    <span>Deliver ${formatTimeDisplay(trip.durations.delivering)}</span>
                </div>
            </div>
        `;
    });

    // Calculate required height based on number of orders
    const timelineHeight = Math.max(80, sortedTrips.length * 30);

    statsContent.innerHTML = `
        <div>
            <!-- Phase Totals -->
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 20px;">
                <div style="background: white; border-radius: 12px; padding: 14px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <div style="font-size: 11px; font-weight: 600; color: #666; text-transform: uppercase; letter-spacing: 0.8px;">Driving</div>
                    <div style="font-size: 18px; font-weight: 700; margin-top: 6px; color: #006B75;">${formatTimeDisplay(totalDriving, false)}</div>
                </div>
                <div style="background: white; border-radius: 12px; padding: 14px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <div style="font-size: 11px; font-weight: 600; color: #666; text-transform: uppercase; letter-spacing: 0.8px;">Shopping</div>
                    <div style="font-size: 18px; font-weight: 700; margin-top: 6px; color: #006B75;">${formatTimeDisplay(totalShopping, false)}</div>
                </div>
                <div style="background: white; border-radius: 12px; padding: 14px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <div style="font-size: 11px; font-weight: 600; color: #666; text-transform: uppercase; letter-spacing: 0.8px;">Delivering</div>
                    <div style="font-size: 18px; font-weight: 700; margin-top: 6px; color: #006B75;">${formatTimeDisplay(totalDelivering, false)}</div>
                </div>
            </div>

            <!-- Timeline Container -->
            <div style="background: white; border-radius: 16px; padding: 16px; position: relative; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                <!-- Hour labels -->
                <div style="position: relative; height: 18px; margin-bottom: 5px;">
                    ${hourLabels}
                </div>

                <!-- Timeline grid lines -->
                <div style="position: relative; height: ${timelineHeight}px; border-left: 1px solid #ddd; border-right: 1px solid #ddd;">
                    <!-- Vertical grid lines every 3 hours -->
                    ${Array.from({length: 7}, (_, i) => {
                        const leftPercent = (i * 3 / 18) * 100;
                        return `<div style="position: absolute; left: ${leftPercent}%; top: 0; bottom: 0; border-left: 1px dashed #e0e0e0;"></div>`;
                    }).join('')}

                    <!-- Order bars -->
                    ${orderBars}
                </div>
            </div>

            <!-- Back Button -->
            <div style="text-align: center; margin-top: 16px;">
                <span onclick="updateStats()" style="color: #006B75; font-size: 14px; font-weight: 600; cursor: pointer;">â† Back</span>
            </div>
        </div>
    `;
}

// Show tooltip on hover
function showTimelineTooltip(index, event) {
    const tooltip = document.getElementById(`timeline-tooltip-${index}`);
    const bar = document.getElementById(`timeline-bar-${index}`);
    if (tooltip && bar) {
        tooltip.style.display = 'block';
        bar.style.transform = 'scaleY(1.1)';
        bar.style.boxShadow = '0 4px 12px rgba(0,0,0,0.2)';
    }
}

// Hide tooltip
function hideTimelineTooltip(index) {
    const tooltip = document.getElementById(`timeline-tooltip-${index}`);
    const bar = document.getElementById(`timeline-bar-${index}`);
    if (tooltip && bar) {
        tooltip.style.display = 'none';
        bar.style.transform = 'none';
        bar.style.boxShadow = '0 2px 4px rgba(0,0,0,0.1)';
    }
}

// Show detailed order view from timeline
function showTimelineOrderDetail(index, period) {
    const filteredTrips = filterTripsByPeriod(period);
    const sortedTrips = [...filteredTrips].sort((a, b) => {
        const aStart = new Date(a.timestamp).getTime() - (a.durations.total * 1000);
        const bStart = new Date(b.timestamp).getTime() - (b.durations.total * 1000);
        return aStart - bStart;
    });

    const trip = sortedTrips[index];

    // Find this trip in the main tripHistory to get its actual index
    const historyIndex = tripHistory.findIndex(t =>
        t.timestamp.getTime() === trip.timestamp.getTime() &&
        t.durations.total === trip.durations.total
    );

    if (historyIndex !== -1) {
        showPage('history');
        setTimeout(() => showOrderDetail(historyIndex, 'stats'), 100);
    }
}

// Filter trips by time period
function filterTripsByPeriod(period) {
    const now = new Date();
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate()); // Start of today
    
    return tripHistory.filter(trip => {
        const tripDate = new Date(trip.timestamp);
        
        switch(period) {
            case 'today':
                // Only today (Feb 3, 2026)
                return tripDate >= today;
            
            case 'yesterday':
                // Only yesterday (Feb 2, 2026)
                const yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 1);
                const dayBeforeYesterday = new Date(yesterday);
                dayBeforeYesterday.setDate(dayBeforeYesterday.getDate() - 1);
                return tripDate >= dayBeforeYesterday && tripDate < yesterday;
            
            case 'thisWeek':
                // Since nearest Monday (Feb 2, 2026)
                // Find the most recent Monday
                const dayOfWeek = today.getDay(); // 0 = Sunday, 1 = Monday, etc.
                const daysToMonday = dayOfWeek === 0 ? 6 : dayOfWeek - 1; // If Sunday, go back 6 days
                const thisMonday = new Date(today);
                thisMonday.setDate(thisMonday.getDate() - daysToMonday);
                return tripDate >= thisMonday;
            
            case 'thisMonth':
                // Since Feb 1, 2026
                const firstOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                return tripDate >= firstOfMonth;
            
            case 'allTime':
                // Everything
                return true;
            
            case 'custom':
                // TODO: Implement custom date range
                return true;
            
            default:
                return true;
        }
    });
}

// Calculate statistics from filtered trips
function calculateStats(trips) {
    // Total orders (sum of all individual deliveries)
    const totalOrders = trips.reduce((sum, trip) => sum + trip.orderCount, 0);
    
    // Time working (sum of all trip durations)
    const timeWorking = trips.reduce((sum, trip) => sum + trip.durations.total, 0);
    
    // Average time per order
    const avgTimePerOrder = totalOrders > 0 ? Math.floor(timeWorking / totalOrders) : 0;
    
    return {
        totalOrders,
        timeWorking,
        avgTimePerOrder
    };
}
        // Helper: Format time for compact display (e.g. "16 min" or "1 hr 05 min")
        // Set showTooLongWarning to false for aggregate stats that can legitimately exceed 6 hours
        function formatTimeDisplay(seconds, showTooLongWarning = true) {
            const totalMinutes = Math.floor(seconds / 60);

            if (showTooLongWarning && totalMinutes > 360) {
                return "You took too long - 0 stars";
            }

            const hours = Math.floor(totalMinutes / 60);
            const mins = totalMinutes % 60;

            if (hours === 0) {
                return `${mins} min`;
            } else {
                return `${hours} hr ${String(mins).padStart(2, '0')} min`;
            }
        }

        // Helper: Format date compactly (e.g. "Feb 3, 10:14 PM")
        function formatCompactDate(date) {
            const d = new Date(date);
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const month = months[d.getMonth()];
            const day = d.getDate();
            const hours = d.getHours();
            const minutes = String(d.getMinutes()).padStart(2, '0');
            const ampm = hours >= 12 ? 'PM' : 'AM';
            const displayHours = hours % 12 || 12;
            
            return `${month} ${day}, ${displayHours}:${minutes} ${ampm}`;
        }
        // Helper: Format date compactly (e.g. "Feb 3, 10:14 PM")
function formatCompactDate(date) {
    const d = new Date(date);
    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    const month = months[d.getMonth()];
    const day = d.getDate();
    const hours = d.getHours();
    const minutes = String(d.getMinutes()).padStart(2, '0');
    const ampm = hours >= 12 ? 'PM' : 'AM';
    const displayHours = hours % 12 || 12;
    
    return `${month} ${day}, ${displayHours}:${minutes} ${ampm}`;
}

// Helper: Format date for detail view (e.g. "Feb 3, 10:40 AM")
function formatDetailDate(date) {
    const d = new Date(date);
    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    const month = months[d.getMonth()];
    const day = d.getDate();
    const hours = d.getHours();
    const minutes = String(d.getMinutes()).padStart(2, '0');
    const ampm = hours >= 12 ? 'PM' : 'AM';
    const displayHours = hours % 12 || 12;
    
    return `${month} ${day}, ${displayHours}:${minutes} ${ampm}`;
}

        // Load history on page load
        window.addEventListener('load', () => {
            // Restore any in-progress trip from localStorage
            restoreTripState();

            storage.loadOrders()
                .then(data => {
                    if (data.success && data.orders) {
                        tripHistory = data.orders.map(trip => ({
                            ...trip,
                            timestamp: new Date(trip.timestamp)
                        }));
                        displayHistory();
                        // Refresh stats view if stats page is active
                        if (document.getElementById('statsPage').classList.contains('active')) {
                            showStatsView();
                        }
                    }
                })
                .catch(error => console.error('Error loading history:', error));
        });
    </script>
</body>
</html>